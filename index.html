<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Альбом</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" href="favicon.png" type="image/png">

  <!-- Open Graph -->
  <meta property="og:type" content="music.album">
  <meta property="og:title" content="Аралдың ақмаралы">
  <meta property="og:description" content="Менің сүйікті әндерім">
  <meta property="og:image" content="https://n-askhat-r.github.io/soundplay/album-cover.jpg">
  <meta property="og:url" content="https://n-askhat-r.github.io/soundplay/">
  <meta property="og:site_name" content="Музыкалық альбом">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Аралдың ақмаралы">
  <meta name="twitter:description" content="Менің сүйікті әндерім">
  <meta name="twitter:image" content="https://n-askhat-r.github.io/soundplay/album-cover.jpg">

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="album-container">
  <header class="album-header">
    <div class="album-info">
      <div class="album-author">
        Альбомның авторы: <strong id="album-author">—</strong>
      </div>
      <h1 class="album-title" id="album-title">Альбом</h1>
      <p class="album-description" id="album-description">
        Альбом деректері жүктелуде...
      </p>
    </div>

    <div class="album-cover-wrap">
      <div class="album-cover-play" id="cover-play">
        <img src="" alt="Альбом мұқабасы" class="album-cover-img" id="album-cover">
        <div class="play-overlay" id="play-overlay"></div>
      </div>
    </div>
  </header>

  <div class="album-body">
    <!-- СПИСОК ТРЕКОВ — будет заполнен из JSON -->
    <ul id="playlist" class="playlist">
      <!-- Треки подгружаются из album.json -->
    </ul>

    <!-- БЛОК ПЛЕЕРА -->
    <div class="player-block">
      <div id="player-bar">
        <div class="now-playing-label">Қазір ойнатылып жатыр</div>
        <div id="now-playing-title" class="now-playing-title">—</div>
        <div id="now-playing-artist" class="now-playing-artist"></div>

        <audio id="audio-player" controls>
          Сіздің браузеріңіз аудио ойнатуды қолдамайды.
        </audio>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const audio = document.getElementById('audio-player');

    const nowPlayingTitle = document.getElementById('now-playing-title');
    const nowPlayingArtist = document.getElementById('now-playing-artist');
    const playlistEl = document.getElementById('playlist');

    const albumTitleEl = document.getElementById('album-title');
    const albumAuthorEl = document.getElementById('album-author');
    const albumDescEl = document.getElementById('album-description');
    const albumCoverEl = document.getElementById('album-cover');

    // Обложка как кнопка Play
    const coverPlay = document.getElementById('cover-play');
    const playOverlay = document.getElementById('play-overlay');

    // Ключ localStorage (отдельно для каждого пути)
    const STORAGE_KEY = 'albumPlayerState_' + location.pathname;

    let playlistItems = [];
    let currentIndex = 0;

    // ---------- localStorage ----------
    function saveState() {
      if (!playlistItems.length) return;

      const state = {
        index: currentIndex,
        src: (playlistItems[currentIndex] && playlistItems[currentIndex].dataset.src) ? playlistItems[currentIndex].dataset.src : '',
        time: (typeof audio.currentTime === 'number' && isFinite(audio.currentTime)) ? audio.currentTime : 0
      };

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        // ignore
      }
    }

    function loadSavedState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const st = JSON.parse(raw);
        if (!st || typeof st.index !== 'number') return null;
        return st;
      } catch (e) {
        return null;
      }
    }

    // ---------- UI helpers ----------
    function setActive(index) {
      playlistItems.forEach((item, i) => item.classList.toggle('active', i === index));
    }

    function updateNowPlayingFromItem(item) {
      const titleEl = item.querySelector('.track-title');
      const title = titleEl ? titleEl.textContent.trim() : '—';
      const artist = item.dataset.artist || '';

      nowPlayingTitle.textContent = title;
      nowPlayingArtist.textContent = artist ? ('Исполнитель: ' + artist) : '';
    }

    function safePlay() {
      const p = audio.play();
      if (p && typeof p.catch === 'function') p.catch(() => {});
    }

    function safePause() {
      try { audio.pause(); } catch (e) {}
    }

    function setOverlayVisible(visible) {
      if (!playOverlay) return;
      if (visible) playOverlay.classList.remove('hidden');
      else playOverlay.classList.add('hidden');
    }

    // ---------- Track loading ----------
    function loadTrack(index, autoplay) {
      if (index < 0 || index >= playlistItems.length) return;

      currentIndex = index;
      const item = playlistItems[index];
      const src = item.dataset.src;

      if (!src) return;

      audio.src = src;
      updateNowPlayingFromItem(item);
      setActive(index);

      // Сохраняем сразу при смене трека
      saveState();

      if (autoplay) {
        safePlay();
      }
    }

    // ---------- Build playlist ----------
    function buildTrack(track, index) {
      const li = document.createElement('li');
      li.dataset.src = track.src;
      if (track.artist) li.dataset.artist = track.artist;

      li.innerHTML = `
        <div class="track-row">
          <span class="track-number">${index + 1}</span>
          <span class="track-title">${track.title || ('Трек ' + (index + 1))}</span>
        </div>
        <div class="track-artist">${track.artist ? ('Исполнитель: ' + track.artist) : ''}</div>
      `;
      return li;
    }

    function attachPlaylistHandlers() {
      playlistItems.forEach((item, index) => {
        item.addEventListener('click', () => loadTrack(index, true));
      });
    }

    // ---------- Album meta ----------
    function applyAlbumMeta(album) {
      const title = album && album.title ? String(album.title) : 'Альбом';
      const author = album && album.author ? String(album.author) : '—';
      const desc = album && album.description ? String(album.description) : '';

      albumTitleEl.textContent = title;
      albumAuthorEl.textContent = author;
      albumDescEl.textContent = desc;
      document.title = title;

      if (album && album.cover) {
        albumCoverEl.src = album.cover;
        albumCoverEl.style.display = 'block';
      } else {
        albumCoverEl.style.display = 'none';
      }

      // по умолчанию показываем треугольник (если не играет)
      setOverlayVisible(audio.paused);
    }

    // ---------- Restore position ----------
    function restoreSavedPlayback(saved) {
      if (!saved) return false;

      let idx = saved.index;
      if (!isFinite(idx) || idx < 0 || idx >= playlistItems.length) idx = 0;

      // Загружаем трек БЕЗ autoplay, выставим время после loadedmetadata
      loadTrack(idx, false);

      const seekTime = (typeof saved.time === 'number' && isFinite(saved.time) && saved.time > 0) ? saved.time : 0;
      if (seekTime > 0) {
        const onMeta = () => {
          // если duration известна — подрежем время
          if (isFinite(audio.duration) && audio.duration > 0) {
            audio.currentTime = Math.min(seekTime, Math.max(audio.duration - 0.25, 0));
          } else {
            audio.currentTime = seekTime;
          }
          audio.removeEventListener('loadedmetadata', onMeta);
        };
        audio.addEventListener('loadedmetadata', onMeta);
      }

      // Автоплей попробуем, но браузер может заблокировать. Это ок — пользователь нажмёт на обложку.
      safePlay();
      return true;
    }

    // ---------- Events ----------
    // Конец трека -> следующий
    audio.addEventListener('ended', () => {
      const next = currentIndex + 1;
      if (next < playlistItems.length) {
        loadTrack(next, true);
      } else {
        // Можно зациклить:
        // loadTrack(0, true);
        saveState();
        setOverlayVisible(true);
      }
    });

    // Сохранение позиции (не слишком часто)
    let lastSaveTs = 0;
    audio.addEventListener('timeupdate', () => {
      const now = Date.now();
      if (now - lastSaveTs > 1200) { // примерно раз в 1.2 сек
        saveState();
        lastSaveTs = now;
      }
    });

    audio.addEventListener('pause', () => {
      saveState();
      setOverlayVisible(true);
    });

    audio.addEventListener('play', () => {
      setOverlayVisible(false);
    });

    window.addEventListener('beforeunload', saveState);

    // Обложка: play/pause по клику
    if (coverPlay) {
      coverPlay.addEventListener('click', () => {
        if (!playlistItems.length) return;

        // Если src ещё не установлен (например, пока грузится JSON), попробуем поставить первый трек
        if (!audio.src || audio.src === '') {
          loadTrack(0, true);
          return;
        }

        if (audio.paused) safePlay();
        else safePause();
      });
    }

    // ---------- Load album.json ----------
    function loadAlbum() {
      fetch('album.json', { cache: 'no-store' })
        .then(async (res) => {
          const text = await res.text();
          if (!res.ok) throw new Error('HTTP ' + res.status);
          try {
            return JSON.parse(text);
          } catch (e) {
            throw new Error('album.json не является JSON (возможно, 404/HTML вместо JSON)');
          }
        })
        .then((data) => {
          const album = data && data.album ? data.album : {};
          const tracks = Array.isArray(data && data.tracks ? data.tracks : []) ? data.tracks : [];

          applyAlbumMeta(album);

          playlistEl.innerHTML = '';
          tracks.forEach((t, i) => {
            if (!t || !t.src) return;
            playlistEl.appendChild(buildTrack(t, i));
          });

          playlistItems = Array.from(playlistEl.querySelectorAll('li[data-src]'));
          attachPlaylistHandlers();

          if (!playlistItems.length) {
            nowPlayingTitle.textContent = 'Нет треков';
            nowPlayingArtist.textContent = '';
            setOverlayVisible(true);
            return;
          }

          // Восстановление состояния (трек+позиция)
          const saved = loadSavedState();
          const restored = restoreSavedPlayback(saved);

          // Если нечего восстанавливать — ставим первый трек, autoplay пробуем
          if (!restored) {
            loadTrack(0, true);
          }
        })
        .catch((err) => {
          console.error('Ошибка загрузки данных альбома:', err);
          albumDescEl.textContent = 'Ошибка загрузки данных альбома.';
          nowPlayingTitle.textContent = 'Ошибка';
          nowPlayingArtist.textContent = '';
          setOverlayVisible(true);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // До загрузки данных пусть треугольник виден (если есть обложка)
      setOverlayVisible(true);
      loadAlbum();
    });
  })();
</script>
</body>
</html>
