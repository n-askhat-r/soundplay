<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <title>Альбом</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">

  <!-- Favicon -->
  <link rel="icon" href="favicon.png" type="image/png">

  <!-- Open Graph -->
  <meta property="og:type" content="music.album">
  <meta property="og:title" content="Аралдың ақмаралы">
  <meta property="og:description" content="Менің сүйікті әндерім">
  <meta property="og:image" content="album-cover.jpg">
  <meta property="og:url" content="https://n-askhat-r.github.io/soundplay/">
  <meta property="og:site_name" content="Музыкалық альбом">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Аралдың ақмаралы">
  <meta name="twitter:description" content="Менің сүйікті әндерім">
  <meta name="twitter:image" content="album-cover.jpg">

  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="album-container">
  <header class="album-header">
    <div class="album-info">
      <div class="album-author">
        Альбомның авторы: <strong id="album-author">—</strong>
      </div>
      <h1 class="album-title" id="album-title">Альбом</h1>
      <p class="album-description" id="album-description">
        Альбом деректері жүктелуде...
      </p>
    </div>

    <div class="album-cover-wrap">
      <!-- Обложка подставится из JSON -->
      <img src="" alt="Альбом мұқабасы" class="album-cover-img" id="album-cover" style="display:none;">
    </div>
  </header>

  <div class="album-body">
    <!-- СПИСОК ТРЕКОВ — будет заполнен из JSON -->
    <ul id="playlist" class="playlist">
      <!-- Треки подгружаются из album.json -->
    </ul>

    <!-- БЛОК ПЛЕЕРА -->
    <div class="player-block">
      <div id="player-bar">
        <div class="now-playing-label">Қазір ойнатылып жатыр</div>
        <div id="now-playing-title" class="now-playing-title">—</div>
        <div id="now-playing-artist" class="now-playing-artist"></div>

        <audio id="audio-player" controls>
          Сіздің браузеріңіз аудио ойнатуды қолдамайды.
        </audio>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const audio = document.getElementById('audio-player');
    const nowPlayingTitle = document.getElementById('now-playing-title');
    const nowPlayingArtist = document.getElementById('now-playing-artist');
    const playlistEl = document.getElementById('playlist');

    const albumTitleEl = document.getElementById('album-title');
    const albumAuthorEl = document.getElementById('album-author');
    const albumDescEl = document.getElementById('album-description');
    const albumCoverEl = document.getElementById('album-cover');

    // Ключ для localStorage – привязываем к пути, чтобы для разных альбомов были разные сохранения
    const STORAGE_KEY = 'albumPlayerState_' + location.pathname;

    let playlistItems = [];
    let currentIndex = 0;

    // ====== Работа с localStorage ======
    function saveState() {
      if (!playlistItems.length) return;

      const state = {
        index: currentIndex,
        // currentSrc может быть абсолютным URL, но нам важнее индекс
        src: playlistItems[currentIndex].dataset.src || '',
        time: audio.currentTime || 0
      };

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        // Если localStorage недоступен, просто молча игнорируем
        console.log('Ойыншы күйін сақтау сәтсіз аяқталды:', e);
      }
    }

    function loadSavedState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const state = JSON.parse(raw);
        if (typeof state.index !== 'number') return null;
        return state;
      } catch (e) {
        console.log('Ойыншы күйін оқу мүмкін болмады:', e);
        return null;
      }
    }

    // ====== Вспомогательные функции ======
    function setActive(index) {
      playlistItems.forEach((item, i) => {
        item.classList.toggle('active', i === index);
      });
    }

    function loadTrack(index, autoplay = false) {
      if (index < 0 || index >= playlistItems.length) return;

      currentIndex = index;
      const item = playlistItems[index];
      const src = item.dataset.src;
      const artist = item.dataset.artist || '';
      const titleEl = item.querySelector('.track-title');
      const title = titleEl ? titleEl.textContent.trim() : '—';

      audio.src = src;
      nowPlayingTitle.textContent = title;
      nowPlayingArtist.textContent = artist ? 'Орындаушы: ' + artist : '';
      setActive(index);

      if (autoplay) {
        const playPromise = audio.play();
        if (playPromise) {
          playPromise.catch((err) => {
            // Браузер может заблокировать автоплей — это нормально
            console.log('Автоматты ойнату браузер тарапынан бөгелген:', err);
          });
        }
      }

      // сразу сохраняем состояние при смене трека
      saveState();
    }

    function buildTrack(track, index) {
      const li = document.createElement('li');
      li.dataset.src = track.src;
      if (track.artist) li.dataset.artist = track.artist;

      li.innerHTML = `
        <div class="track-row">
          <span class="track-number">${index + 1}</span>
          <span class="track-title">${track.title}</span>
        </div>
        <div class="track-artist">
          ${track.artist ? 'Орындаушы: ' + track.artist : ''}
        </div>
      `;
      return li;
    }

    function attachHandlers() {
      playlistItems.forEach((item, index) => {
        item.addEventListener('click', () => loadTrack(index, true));
      });

      // Сохраняем позицию по ходу проигрывания
      audio.addEventListener('timeupdate', () => {
        // сохраняем не на каждый миллисекундный вызов, а немного реже
        // но для простоты можно сохранять всегда – нагрузка минимальная
        saveState();
      });

      // На паузе тоже сохраняем
      audio.addEventListener('pause', saveState);

      // Перед закрытием страницы
      window.addEventListener('beforeunload', saveState);
    }

    function applyAlbumMeta(album) {
      if (album.title) {
        albumTitleEl.textContent = album.title;
        document.title = album.title;
      }
      if (album.author) {
        albumAuthorEl.textContent = album.author;
      }
      if (album.description) {
        albumDescEl.textContent = album.description;
      } else {
        albumDescEl.textContent = '';
      }
      if (album.cover) {
        albumCoverEl.src = album.cover;
        albumCoverEl.style.display = 'block';
      } else {
        albumCoverEl.style.display = 'none';
      }
    }

    function loadAlbum() {
      fetch('album.json')
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(data => {
          const album = data.album || {};
          const tracks = Array.isArray(data.tracks) ? data.tracks : [];

          applyAlbumMeta(album);

          playlistEl.innerHTML = '';
          tracks.forEach((track, i) => {
            if (!track.src) return;
            playlistEl.appendChild(buildTrack(track, i));
          });

          playlistItems = Array.from(playlistEl.querySelectorAll('li'));
          attachHandlers();

          if (!playlistItems.length) {
            nowPlayingTitle.textContent = 'Тректер жоқ';
            return;
          }

          // Пытаемся восстановить состояние
          const saved = loadSavedState();
          if (saved) {
            let index = saved.index;
            if (index < 0 || index >= playlistItems.length) index = 0;

            // Загружаем трек без автоплея (пока)
            loadTrack(index, false);

            // Восстанавливаем позицию после загрузки метаданных
            const seekTime = saved.time || 0;
            if (seekTime > 0) {
              const setTime = () => {
                // На случай, если длительность меньше сохранённого времени
                if (!isNaN(audio.duration) && seekTime > audio.duration) {
                  audio.currentTime = Math.max(audio.duration - 1, 0);
                } else {
                  audio.currentTime = seekTime;
                }
                audio.removeEventListener('loadedmetadata', setTime);
              };
              audio.addEventListener('loadedmetadata', setTime);
            }

            // Пробуем автоматически продолжить воспроизведение
            const playPromise = audio.play();
            if (playPromise) {
              playPromise.catch((err) => {
                // Если браузер потребует ручного Play — пользователь просто нажмёт кнопку
                console.log('Қалпына келтірілгеннен кейін автоматты ойнату бұғатталады:', err);
              });
            }
          } else {
            // Если сохранённого состояния нет — начинаем с первого трека
            loadTrack(0, true);
          }
        })
        .catch(err => {
          console.error('album.json жүктеу кезінде қате пайда болды:', err);
          albumDescEl.textContent = 'Альбом деректерін жүктеу қатесі.';
        });
    }

    // Когда трек заканчивается — сохраняем и переходим к следующему
    audio.addEventListener('ended', () => {
      if (currentIndex + 1 < playlistItems.length) {
        loadTrack(currentIndex + 1, true);
      } else {
        // В конце плейлиста можно сохранить, что мы на последнем треке в конце
        saveState();
      }
    });

    document.addEventListener('DOMContentLoaded', loadAlbum);
  })();
</script>

</body>
</html>
